version: "1.0"
type: component
data:
  name: omv-services-writecache-form-page
  type: formPage
  config:
    request:
      service: WriteCache
      get:
        method: getSettings
      post:
        method: setSettings
    fields:
      - type: checkbox
        name: enable
        label: _("Enabled")
        value: true
      - type: checkbox
        name: use_tmpfs
        label: _("Use system memory")
        value: true
        hint: _("If checked, writecache will use system memory to store changes.<br/>If unchecked, writecache will store those changes in the selected shared folder. Changes are not lost if the system reboots or shuts down unexpectedly.")
      - type: sharedFolderSelect
        name: sharedfolderref
        label: _("Workspace folder")
        hint: _("Used to store temporary writecache changes.")
        modifiers:
          - type: visible
            constraint:
              operator: falsy
              arg0:
                prop: use_tmpfs
          - type: value
            typeConfig: ""
            constraint:
              operator: truthy
              arg0:
                prop: use_tmpfs
      - type: textInput
        name: tmpfs_size
        label: _("tmpfs size")
        value: "25%"
        hint: _("Size for /run/omv-writecache tmpfs. Accepts %, M/G suffix; e.g. 512M, 2G, 25%.")
        modifiers:
          - type: visible
            constraint:
              operator: truthy
              arg0:
                prop: use_tmpfs
      - type: select
        name: journald_storage
        label: _("Journal storage")
        value: "volatile"
        store:
          data:
            - ["auto", _("auto")]
            - ["volatile", _("volatile (RAM)")]
            - ["persistent", _("persistent (disk)")]
      - type: checkbox
        name: flush_on_boot
        label: _("Flush on boot")
        value: false
        modifiers:
          - type: visible
            constraint:
              operator: falsy
              arg0:
                prop: use_tmpfs
          - type: unchecked
            constraint:
              operator: falsy
              arg0:
                prop: use_tmpfs
      - type: container
        fields:
          - type: checkbox
            name: flush_on_shutdown
            label: _("Flush on shutdown")
            value: true
          - type: checkbox
            name: rotate_on_shutdown
            label: _("Rotate on shutdown")
            value: true
            hint: _("Run journalctl rotate and sync before flush")
            modifiers:
              - type: visible
                constraint:
                  operator: truthy
                  arg0:
                    prop: flush_on_shutdown
      - type: container
        fields:
          - type: checkbox
            name: flush_daily
            label: _("Flush daily")
            value: false
            hint: _("Will flush daily at specified time")
          - type: select
            name: hour
            label: _("Hour")
            value: 3
            modifiers:
              - type: visible
                constraint:
                  operator: truthy
                  arg0:
                    prop: flush_daily
            store:
              data:
                - [0, 0]
                - [1, 1]
                - [2, 2]
                - [3, 3]
                - [4, 4]
                - [5, 5]
                - [6, 6]
                - [7, 7]
                - [8, 8]
                - [9, 9]
                - [10, 10]
                - [11, 11]
                - [12, 12]
                - [13, 13]
                - [14, 14]
                - [15, 15]
                - [16, 16]
                - [17, 17]
                - [18, 18]
                - [19, 19]
                - [20, 20]
                - [21, 21]
                - [22, 22]
                - [23, 23]
          - type: select
            name: minute
            label: _("Minute")
            value: 45
            modifiers:
              - type: visible
                constraint:
                  operator: truthy
                  arg0:
                    prop: flush_daily
            store:
              data:
                - [0, 0]
                - [1, 1]
                - [2, 2]
                - [3, 3]
                - [4, 4]
                - [5, 5]
                - [6, 6]
                - [7, 7]
                - [8, 8]
                - [9, 9]
                - [10, 10]
                - [11, 11]
                - [12, 12]
                - [13, 13]
                - [14, 14]
                - [15, 15]
                - [16, 16]
                - [17, 17]
                - [18, 18]
                - [19, 19]
                - [20, 20]
                - [21, 21]
                - [22, 22]
                - [23, 23]
                - [24, 24]
                - [25, 25]
                - [26, 26]
                - [27, 27]
                - [28, 28]
                - [29, 29]
                - [30, 30]
                - [31, 31]
                - [32, 32]
                - [33, 33]
                - [34, 34]
                - [35, 35]
                - [36, 36]
                - [37, 37]
                - [38, 38]
                - [39, 39]
                - [40, 40]
                - [41, 41]
                - [42, 42]
                - [43, 43]
                - [44, 44]
                - [45, 45]
                - [46, 46]
                - [47, 47]
                - [48, 48]
                - [49, 49]
                - [50, 50]
                - [51, 51]
                - [52, 52]
                - [53, 53]
                - [54, 54]
                - [55, 55]
                - [56, 56]
                - [57, 57]
                - [58, 58]
                - [59, 59]
          - type: checkbox
            name: rotate_on_daily_flush
            label: _("Rotate on daily flush")
            value: true
            hint: _("Run journalctl rotate and sync before flush")
            modifiers:
              - type: visible
                constraint:
                  operator: truthy
                  arg0:
                    prop: flush_daily
      - type: textarea
        name: paths
        label: _("Overlay paths and policy")
        rows: 10
        monospace: true
        hint: _("One entry per line <path> = drop|flush")
      - type: textarea
        name: status
        label: _("Status")
        rows: 12
        monospace: true
        submitValue: false
    buttons:
      - template: submit
      - template: cancel
      - text: _("Flush")
        enabledConstraint:
          operator: truthy
          arg0:
            prop: enable
        execute:
          type: taskDialog
          taskDialog:
            config:
              title: _("Running manual flush ...")
              startOnInit: true
              request:
                service: WriteCache
                method: doFlush
                params:
                  rotate: false
              buttons:
                stop:
                  hidden: true
      - text: _("Rotate & Flush")
        enabledConstraint:
          operator: truthy
          arg0:
            prop: enable
        execute:
          type: taskDialog
          taskDialog:
            config:
              title: _("Running manual rotate and flush ...")
              startOnInit: true
              request:
                service: WriteCache
                method: doFlush
                params:
                  rotate: true
              buttons:
                stop:
                  hidden: true
